<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­è¯•å·åˆ†æç³»ç»Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
        
        /* === é¡µé¢1ï¼šèœå•é¡µæ ·å¼ (Directory) === */
        #menu-screen { display: none; text-align: center; }
        .hero-title { color: #2c3e50; margin-bottom: 30px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; border-top: 5px solid #5bc0de; text-align: left; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #333; }
        .card p { color: #666; font-size: 0.9em; height: 40px; }
        
        .btn-copy { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 8px; }
        .btn-preview { width: 100%; padding: 8px; background-color: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
        .btn-copy:hover { background-color: #218838; }
        .btn-preview:hover { background-color: #e2e6ea; }

        /* === é¡µé¢2ï¼šå·¥å…·é¡µæ ·å¼ (Tool) === */
        #tool-screen { display: none; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; }
        
        .info-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .info-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #eee; padding: 10px 5px; text-align: center; }
        th { background: #f8f9fa; color: #555; }
        
        select, input[type="text"], input[type="number"] { width: 95%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; text-align: center; }
        
        .summary-box { background: #eef2f5; padding: 15px; border-radius: 6px; display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 20px; }
        
        .action-bar { text-align: center; border-top: 2px dashed #eee; padding-top: 20px; }
        .btn-submit { background-color: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        .btn-submit:hover { background-color: #0056b3; }
        
        .back-link { display: inline-block; margin-bottom: 10px; text-decoration: none; color: #666; font-size: 0.9em; cursor: pointer;}

    </style>
</head>
<body>

    <div id="menu-screen">
        <h1 class="hero-title">ğŸ“‚ è¯•å·åˆ†æåˆ†å‘ä¸­å¿ƒ</h1>
        <p style="color:#666">é€‰æ‹©ä¸€ç§è¯•å·ç±»å‹ï¼Œå¤åˆ¶é“¾æ¥å‘ç»™å­¦ç”Ÿå³å¯ã€‚</p>
        
        <div class="grid-container" id="card-container">
            </div>
    </div>

    <div id="tool-screen">
        <div onclick="goHome()" class="back-link">â† è¿”å›èœå• (ä»…è€å¸ˆå¯è§)</div>
        <h2 id="page-title">è¯•å·å¤±åˆ†åˆ†æ</h2>

        <div class="info-row">
            <input type="text" id="studentName" placeholder="å­¦ç”Ÿå§“å">
            <input type="text" id="examName" placeholder="è¯•å·åç§°">
        </div>

        <table id="analysisTable">
            <thead>
                <tr>
                    <th style="width:15%">ç±»å‹</th>
                    <th style="width:15%">é¢˜å·</th>
                    <th style="width:45%">é”™è¯¯åŸå› </th>
                    <th style="width:15%">æ‰£åˆ†</th>
                    <th style="width:10%"></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="addRow()" style="background:#17a2b8; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">+ æ·»åŠ ä¸€è¡Œ</button>
        </div>

        <div class="summary-box">
            <span>KçŸ¥è¯†: <span id="k-total">0</span></span>
            <span>SæŠ€å·§: <span id="s-total">0</span></span>
            <span>Må¿ƒæ€: <span id="m-total">0</span></span>
            <span style="color:#d9534f">æ€»æ‰£åˆ†: <span id="grand-total">0</span></span>
        </div>

        <div class="action-bar">
            <p style="color:#666; font-size:0.9em;">å­¦ç”Ÿå¡«å®Œåï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆç»“æœé“¾æ¥å‘ç»™è€å¸ˆ</p>
            <button class="btn-submit" onclick="generateResultLink()">ğŸ”— ç”Ÿæˆæäº¤é“¾æ¥</button>
            <div id="msg-box" style="margin-top:10px; color:green; font-weight:bold; height:20px;"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”§ ã€é…ç½®åŒºã€‘ æ‰€æœ‰çš„è¯•å·ç±»å‹åœ¨è¿™é‡Œå®šä¹‰
        // ==========================================
        const EXAM_TYPES = {
            "gaokao": {
                title: "é«˜è€ƒè‹±è¯­ (CN)",
                desc: "åŒ…å«å¬åŠ›ã€é˜…è¯»ã€å®Œå½¢ã€è¯­æ³•å¡«ç©ºåŠä½œæ–‡ç»“æ„ã€‚",
                color: "#d9534f", // å¡ç‰‡é¡¶æ¡é¢œè‰²
                rows: [
                    { q: "1-20", r: "å¬åŠ›ç†è§£" },
                    { q: "21-40", r: "é˜…è¯»ç†è§£" },
                    { q: "41-55", r: "å®Œå½¢å¡«ç©º" },
                    { q: "56-65", r: "è¯­æ³•å¡«ç©º" },
                    { q: "Writing", r: "ä¹¦é¢è¡¨è¾¾" }
                ]
            },
            "toefl": {
                title: "æ‰˜ç¦ (TOEFL)",
                desc: "Reading, Listening, Speaking, Writing å…¨ç§‘æ¨¡æ¿ã€‚",
                color: "#5bc0de",
                rows: [
                    { q: "Reading", r: "è¯æ±‡/ç»†èŠ‚/æ¨æ–­" },
                    { q: "Listening", r: "Conversation/Lecture" },
                    { q: "Speaking", r: "Task 1-4" },
                    { q: "Writing", r: "Integrated/Academic" }
                ]
            },
            "general": {
                title: "é€šç”¨ç©ºç™½æ¨¡æ¿",
                desc: "é€‚ç”¨äºä»»ä½•ç§‘ç›®çš„ç®€å•ç©ºç™½è¡¨æ ¼ã€‚",
                color: "#28a745",
                rows: [ { q: "", r: "" } ]
            },
            // ğŸ‘‡ ä½ å¯ä»¥åœ¨è¿™é‡Œæ— é™å¤åˆ¶æ·»åŠ 
            "middle_school": {
                title: "åˆä¸­æœˆè€ƒ",
                desc: "å•é€‰ã€å®Œå½¢ã€é˜…è¯»ã€å®Œæˆå¥å­ã€‚",
                color: "#f0ad4e",
                rows: [
                    { q: "1-15", r: "å•é¡¹é€‰æ‹©" },
                    { q: "16-30", r: "å®Œå½¢å¡«ç©º" },
                    { q: "é˜…è¯»", r: "é˜…è¯»ç†è§£" }
                ]
            }
        };

        // ==========================================
        // æ ¸å¿ƒé€»è¾‘åŒº
        // ==========================================

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            const data = urlParams.get('data');

            if (data) {
                // æƒ…å†µ1ï¼šæŸ¥çœ‹ç»“æœï¼ˆå¸¦æœ‰dataæ•°æ®ï¼‰
                showToolScreen();
                restoreData(data);
            } else if (type && EXAM_TYPES[type]) {
                // æƒ…å†µ2ï¼šå­¦ç”Ÿæ¨¡å¼ï¼ˆå¸¦æœ‰typeå‚æ•°ï¼Œå¦‚ ?type=gaokaoï¼‰
                showToolScreen();
                loadTemplate(type);
                // å­¦ç”Ÿä¸éœ€è¦çœ‹è¿”å›æŒ‰é’®
                document.querySelector('.back-link').style.display = 'none';
            } else {
                // æƒ…å†µ3ï¼šè€å¸ˆæ¨¡å¼ï¼ˆä¸»é¡µï¼‰
                renderMenu();
                document.getElementById('menu-screen').style.display = 'block';
            }
        };

        // æ¸²æŸ“ä¸»é¡µèœå•
        function renderMenu() {
            const container = document.getElementById('card-container');
            container.innerHTML = "";
            
            for (let key in EXAM_TYPES) {
                const item = EXAM_TYPES[key];
                // æ„é€ å­¦ç”Ÿé“¾æ¥
                const studentLink = window.location.origin + window.location.pathname + "?type=" + key;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderTopColor = item.color;
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.desc}</p>
                    <button class="btn-copy" onclick="copyLink('${studentLink}')">å¤åˆ¶ç»™å­¦ç”Ÿçš„é“¾æ¥ ğŸ”—</button>
                    <button class="btn-preview" onclick="location.href='${studentLink}'">è‡ªå·±ç‚¹å¼€çœ‹çœ‹ ğŸ‘€</button>
                `;
                container.appendChild(card);
            }
        }

        // å¤åˆ¶é“¾æ¥åŠŸèƒ½
        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert("é“¾æ¥å·²å¤åˆ¶ï¼\n\nè¯·ç›´æ¥ç²˜è´´å‘ç»™å­¦ç”Ÿï¼Œå­¦ç”Ÿæ‰“å¼€å°±æ˜¯è¿™ä¸ªæ¨¡æ¿ã€‚");
            });
        }

        // åˆ‡æ¢åˆ°å·¥å…·ç•Œé¢
        function showToolScreen() {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('tool-screen').style.display = 'block';
        }

        // åŠ è½½ç‰¹å®šæ¨¡æ¿
        function loadTemplate(key) {
            const config = EXAM_TYPES[key];
            document.getElementById('page-title').innerText = config.title + " - å¤±åˆ†åˆ†æ";
            document.getElementById('examName').value = config.title;
            
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            config.rows.forEach(r => addRow('', r.q, r.r, ''));
            calculate();
        }

        function goHome() {
            window.location.href = window.location.pathname; // å»æ‰å‚æ•°å›åˆ°ä¸»é¡µ
        }

        // --- è¡¨æ ¼æ“ä½œé€»è¾‘ (å’Œä¹‹å‰ä¸€æ ·) ---
        function addRow(t='', q='', r='', s='') {
            const tbody = document.getElementById("tableBody");
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>
                    <select class="type-select" onchange="calculate()">
                        <option value="">-</option>
                        <option value="K" ${t==='K'?'selected':''}>K</option>
                        <option value="S" ${t==='S'?'selected':''}>S</option>
                        <option value="M" ${t==='M'?'selected':''}>M</option>
                    </select>
                </td>
                <td><input type="text" value="${q}"></td>
                <td><input type="text" value="${r}"></td>
                <td><input type="number" class="score" value="${s}" oninput="calculate()" min="0" step="0.5"></td>
                <td><button onclick="this.closest('tr').remove();calculate()" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></td>
            `;
        }

        function calculate() {
            let k=0, s=0, m=0, total=0;
            document.querySelectorAll("#tableBody tr").forEach(row => {
                const type = row.querySelector(".type-select").value;
                const score = parseFloat(row.querySelector(".score").value) || 0;
                if(type==='K') k+=score; if(type==='S') s+=score; if(type==='M') m+=score;
                total+=score;
            });
            document.getElementById('k-total').innerText = k;
            document.getElementById('s-total').innerText = s;
            document.getElementById('m-total').innerText = m;
            document.getElementById('grand-total').innerText = total;
        }

        function generateResultLink() {
            const rows = [];
            document.querySelectorAll("#tableBody tr").forEach(row => {
                rows.push({
                    t: row.querySelector(".type-select").value,
                    q: row.querySelectorAll("input")[0].value,
                    r: row.querySelectorAll("input")[1].value,
                    s: row.querySelectorAll("input")[2].value
                });
            });
            
            const data = {
                n: document.getElementById('studentName').value,
                e: document.getElementById('examName').value,
                rows: rows
            };
            
            const jsonStr = JSON.stringify(data);
            const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
            const resultUrl = window.location.origin + window.location.pathname + "?data=" + base64;
            
            navigator.clipboard.writeText(resultUrl).then(() => {
                document.getElementById('msg-box').innerText = "âœ… é“¾æ¥å·²ç”Ÿæˆå¹¶å¤åˆ¶ï¼è¯·å‘ç»™è€å¸ˆã€‚";
                alert("å·²å¤åˆ¶ï¼ç›´æ¥ç²˜è´´å‘ç»™è€å¸ˆã€‚");
            });
        }

        function restoreData(dataStr) {
            try {
                const data = JSON.parse(decodeURIComponent(escape(atob(dataStr))));
                document.getElementById('studentName').value = data.n;
                document.getElementById('examName').value = data.e;
                document.getElementById('page-title').innerText = data.n + " çš„åˆ†æç»“æœ";
                
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";
                data.rows.forEach(r => addRow(r.t, r.q, r.r, r.s));
                calculate();
                // ç»“æœé¡µä¹Ÿä¸æ˜¾ç¤ºè¿”å›æŒ‰é’®
                document.querySelector('.back-link').style.display = 'none';
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
