<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­è¯•å·å¤±åˆ†åˆ†æè¡¨</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 850px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; }
        h2 { text-align: center; color: #333; }
        
        /* é¡¶éƒ¨å­¦ç”Ÿä¿¡æ¯ */
        .student-info { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap;}
        .student-info input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 200px; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: bold; color: #555; }
        
        select, input[type="text"], input[type="number"] {
            width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        
        /* ç»Ÿè®¡æ¡æ ·å¼ */
        .summary-box {
            margin-top: 20px; padding: 15px; background: #eef2f5; border: 1px solid #d1d9e6; border-radius: 5px;
            display: flex; justify-content: space-around; font-weight: bold; font-size: 1.1em;
        }
        .total-score { color: #d9534f; font-size: 1.2em; border-bottom: 2px solid #d9534f; }

        /* æŒ‰é’®åŒºåŸŸ */
        .action-bar { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px dashed #ddd; }
        button {
            padding: 12px 24px; margin: 0 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.2s;
        }
        .btn-add { background-color: #5bc0de; color: white; }
        .btn-save-file { background-color: #f0ad4e; color: white; }
        .btn-link { background-color: #5cb85c; color: white; }
        
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .del-btn { background:#d9534f; color:white; padding:5px 10px; width:auto; font-size: 14px;}

        /* æç¤ºä¿¡æ¯ */
        #msg-box { text-align: center; margin-top: 10px; color: green; height: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“ è‹±è¯­è¯•å·å¤±åˆ†åˆ†æ (å¯ä¿å­˜ç‰ˆ)</h2>

    <div class="student-info">
        <input type="text" id="studentName" placeholder="å­¦ç”Ÿå§“å" oninput="updateUrlState()">
        <input type="text" id="examName" placeholder="è¯•å·åç§° (å¦‚: æœŸä¸­è€ƒè¯•)" oninput="updateUrlState()">
    </div>

    <table id="analysisTable">
        <thead>
            <tr>
                <th style="width: 20%">å¤±åˆ†ç±»å‹</th>
                <th style="width: 15%">é¢˜å·</th>
                <th style="width: 40%">é”™è¯¯åŸå› </th>
                <th style="width: 15%">å¤±åˆ†</th>
                <th style="width: 10%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div style="text-align: center; margin-bottom: 10px;">
        <button type="button" class="btn-add" onclick="addRow()">+ æ·»åŠ ä¸€è¡Œ</button>
    </div>

    <div class="summary-box">
        <span>K (çŸ¥è¯†): <span id="k-total">0</span></span>
        <span>S (æŠ€å·§): <span id="s-total">0</span></span>
        <span>M (å¿ƒæ€): <span id="m-total">0</span></span>
        <span class="total-score">æ€»æ‰£åˆ†: <span id="grand-total">0</span></span>
    </div>

    <div class="action-bar">
        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">å¡«å†™å®Œæ¯•åï¼Œé€‰æ‹©ä¸€ç§æ–¹å¼å‘ç»™è€å¸ˆï¼š</p>
        
        <button type="button" class="btn-link" onclick="generateLink()">ğŸ”— å¤åˆ¶åˆ†äº«é“¾æ¥</button>
        <button type="button" class="btn-save-file" onclick="saveAsFile()">ğŸ’¾ ä¿å­˜ä¸ºæ–‡ä»¶</button>
        
        <div id="msg-box"></div>
    </div>

    <script>
        // 1. åˆå§‹åŒ–ï¼šæ£€æŸ¥é“¾æ¥é‡Œæœ‰æ²¡æœ‰æ•°æ®ï¼Œæœ‰çš„è¯å°±æ¢å¤
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataStr = urlParams.get('data');
            
            if (dataStr) {
                try {
                    // è§£ç æ•°æ®
                    const data = JSON.parse(decodeURIComponent(escape(atob(dataStr))));
                    restoreData(data);
                    document.getElementById('msg-box').innerText = "å·²åŠ è½½ä¹‹å‰çš„å¡«å†™è®°å½•ï¼";
                } catch (e) {
                    console.error("æ•°æ®åŠ è½½å¤±è´¥", e);
                    addRow(); // åŠ è½½å¤±è´¥åˆ™æ·»åŠ ç©ºè¡Œ
                }
            } else {
                addRow(); // é»˜è®¤æ·»åŠ ä¸€è¡Œ
            }
        };

        // 2. æ·»åŠ æ–°è¡Œ
        function addRow(type='', qNum='', reason='', score='') {
            const tbody = document.getElementById("analysisTable").getElementsByTagName('tbody')[0];
            const newRow = tbody.insertRow();
            
            newRow.innerHTML = `
                <td>
                    <select class="type-select" onchange="calculate()">
                        <option value="">--é€‰--</option>
                        <option value="K" ${type==='K'?'selected':''}>K (çŸ¥è¯†)</option>
                        <option value="S" ${type==='S'?'selected':''}>S (æŠ€å·§)</option>
                        <option value="M" ${type==='M'?'selected':''}>M (å¿ƒæ€)</option>
                    </select>
                </td>
                <td><input type="text" class="q-num" value="${qNum}" oninput="updateUrlState()"></td>
                <td><input type="text" class="reason" value="${reason}" oninput="updateUrlState()"></td>
                <td><input type="number" class="score" value="${score}" oninput="calculate()" min="0" step="0.5"></td>
                <td><button type="button" class="del-btn" onclick="deleteRow(this)">Ã—</button></td>
            `;
            calculate();
        }

        // 3. åˆ é™¤è¡Œ
        function deleteRow(btn) {
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            calculate();
        }

        // 4. è®¡ç®—é€»è¾‘
        function calculate() {
            let k = 0, s = 0, m = 0, total = 0;
            const rows = document.querySelectorAll("#analysisTable tbody tr");

            rows.forEach(row => {
                const type = row.querySelector(".type-select").value;
                const score = parseFloat(row.querySelector(".score").value) || 0;

                if (type === "K") k += score;
                if (type === "S") s += score;
                if (type === "M") m += score;
                total += score;
            });

            document.getElementById("k-total").innerText = k;
            document.getElementById("s-total").innerText = s;
            document.getElementById("m-total").innerText = m;
            document.getElementById("grand-total").innerText = total;
            
            updateUrlState(); // æ¯æ¬¡å˜åŠ¨éƒ½å°è¯•æ›´æ–°çŠ¶æ€ï¼ˆä½†ä¸åˆ·æ–°é¡µé¢ï¼‰
        }

        // --- æ ¸å¿ƒé»‘ç§‘æŠ€åŠŸèƒ½ ---

        // è·å–å½“å‰æ‰€æœ‰æ•°æ®
        function getDataObject() {
            const rows = document.querySelectorAll("#analysisTable tbody tr");
            const rowData = [];
            rows.forEach(row => {
                rowData.push({
                    t: row.querySelector(".type-select").value,
                    q: row.querySelector(".q-num").value,
                    r: row.querySelector(".reason").value,
                    s: row.querySelector(".score").value
                });
            });

            return {
                name: document.getElementById("studentName").value,
                exam: document.getElementById("examName").value,
                rows: rowData
            };
        }

        // æ¢å¤æ•°æ®
        function restoreData(data) {
            document.getElementById("studentName").value = data.name || "";
            document.getElementById("examName").value = data.exam || "";
            
            const tbody = document.getElementById("analysisTable").getElementsByTagName('tbody')[0];
            tbody.innerHTML = ""; // æ¸…ç©ºç°æœ‰

            if (data.rows && data.rows.length > 0) {
                data.rows.forEach(r => addRow(r.t, r.q, r.r, r.s));
            } else {
                addRow();
            }
            calculate();
        }

        // åŠŸèƒ½ A: ç”Ÿæˆé•¿é“¾æ¥ (Magic Link)
        function generateLink() {
            const data = getDataObject();
            // ç¼–ç ï¼šJSON -> String -> Base64 -> URLç¼–ç 
            const jsonStr = JSON.stringify(data);
            const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
            
            // æ‹¼æ¥å½“å‰ç½‘é¡µåœ°å€ + å‚æ•°
            const newUrl = window.location.origin + window.location.pathname + "?data=" + base64;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(newUrl).then(() => {
                document.getElementById('msg-box').innerText = "âœ… é“¾æ¥å·²å¤åˆ¶ï¼ç›´æ¥å‘ç»™è€å¸ˆå³å¯ã€‚";
                alert("é“¾æ¥å·²å¤åˆ¶ï¼\n\nè¯·ç›´æ¥åœ¨å¾®ä¿¡ç²˜è´´å‘ç»™è€å¸ˆï¼Œè€å¸ˆç‚¹å¼€å°±èƒ½çœ‹åˆ°ä½ å¡«çš„å†…å®¹ã€‚");
            }).catch(err => {
                prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š", newUrl);
            });
        }

        // åŠŸèƒ½ B: ä¿å­˜ä¸º HTML æ–‡ä»¶ (Solidify State)
        function saveAsFile() {
            // 1. æŠŠæ‰€æœ‰Inputçš„å½“å‰å€¼å†™å…¥åˆ°HTMLå±æ€§ä¸­ (å›ºåŒ–DOM)
            const inputs = document.querySelectorAll("input");
            inputs.forEach(input => input.setAttribute("value", input.value));

            const selects = document.querySelectorAll("select");
            selects.forEach(select => {
                const options = select.querySelectorAll("option");
                options.forEach(opt => {
                    if (opt.value === select.value) opt.setAttribute("selected", "selected");
                    else opt.removeAttribute("selected");
                });
            });

            // 2. è·å–å½“å‰æ•´ä¸ªç½‘é¡µçš„HTMLä»£ç 
            let htmlContent = document.documentElement.outerHTML;

            // 3. åˆ›å»ºä¸‹è½½é“¾æ¥
            const studentName = document.getElementById("studentName").value || "å­¦ç”Ÿ";
            const blob = new Blob([htmlContent], {type: "text/html"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${studentName}_è¯•å·åˆ†æ.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            document.getElementById('msg-box').innerText = "âœ… æ–‡ä»¶å·²ä¸‹è½½ï¼è¯·å°†è¯¥æ–‡ä»¶å‘é€ç»™è€å¸ˆã€‚";
        }

        // è¾…åŠ©ï¼šé™é»˜æ›´æ–°URLï¼ˆä¸åˆ·æ–°ï¼‰ï¼Œæ–¹ä¾¿æ„å¤–å…³é—­åæ¢å¤
        function updateUrlState() {
            // è¿™é‡Œçš„é€»è¾‘ç¨å¾®å¤æ‚ç‚¹å°±ä¸é»˜è®¤å¼€å¯ï¼Œé¿å…URLè¿‡é•¿çœ‹ç€ä¹±
            // å¦‚æœä½ éœ€è¦"åˆ·æ–°é¡µé¢æ•°æ®ä¸ä¸¢å¤±"çš„åŠŸèƒ½å¯ä»¥å¯ç”¨ History API
        }

    </script>
</body>
</html>